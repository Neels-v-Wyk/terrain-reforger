# terrain-reforger

A Terraria terrain generation tool that trains a VQ-VAE on world chunk data and reconstructs/exports terrain as TEdit schematics.

## Setup

```bash
pip install -e .
```

Requires a tModLoader/Terraria installation to generate worlds (see `src/scripts/worldgen.sh`).

## Workflow

The pipeline runs in four steps:

### 1. Generate worlds
```bash
terrain data worldgen --num-worlds 20
```
Outputs `.wld` files to `worldgen/`.

### 2. Analyze worlds (optional — regenerates `src/terraria/natural_ids.py`)
```bash
terrain data analyze
```
Only needed if you want to update the natural block/wall ID mappings from a new set of worlds.

### 3. Prepare dataset
```bash
# Single consolidated .pt file (default, recommended)
terrain data prepare

# Or one .pt per world for large datasets with --disk-mode training
terrain data prepare --mode chunked --output-dir data/cache
```

### 4. Train
```bash
# From consolidated dataset
terrain model train --data data/dataset_optimized.pt

# From chunked dataset (RAM-efficient)
terrain model train --data data/cache --disk-mode

# Resume from latest checkpoint
terrain model train --data data/dataset_optimized.pt --resume checkpoints/latest_model.pt
```

### 5. Infer / Export
```bash
# Print reconstruction quality for a few chunks
terrain model infer

# Export original + reconstructed region as TEdit schematics
terrain model export --x 1500 --y 500 --width 64 --height 64
```
Schematics are written to `exports/` and can be imported via TEdit → File → Import Schematic.

## Notes

- Checkpoints and training plots are saved to `checkpoints/`.
- `worldgen/`, `data/`, and `checkpoints/` are git-ignored.
- Natural block/wall ID mappings live in `src/terraria/natural_ids.py` (generated by `terrain data analyze`).
- The `colab.sh` script under `src/scripts/` runs the full pipeline unattended (useful for Colab/remote training).
